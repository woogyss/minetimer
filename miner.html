<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Timers</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
        }
        
        .active-container {
            display: block;
        }

        .inactive-container {
            display: none;
        }

        #timersContainer {
            margin: 20px;
        }

        .timer {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 5px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .timer-name {
            font-weight: bold;
        }

        .timer-time {
            font-size: 1.2em;
        }

        .alert {
            background-color: #ffcccc;
        }

        .warning {
            background-color: #fff6cc;
        }

        #chatMessages {
            width: 300px;
            max-height: 400px;
            overflow-y: scroll;
            background-color: #fff;
            padding: 10px;
            border: 1px solid #ddd;
            margin-top: 10px;
            border-radius: 5px;
        }

        .message-sender {
            font-weight: bold;
        }

        .message-time {
            font-size: 0.8em;
            color: #777;
        }

        .own-message {
            background-color: #e1f5fe;
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 5px;
        }

        .other-message {
            background-color: #f1f1f1;
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 5px;
        }

        #chatInput {
            width: 300px;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            width: 300px;
            text-align: center;
        }

        .modal input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .modal button {
            padding: 10px 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .modal button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div id="mainContainer" class="active-container">
        <!-- Основной интерфейс с чатами и таймерами -->
        <div id="timersContainer"></div>
        <div id="chatMessages"></div>
        <input type="text" id="chatInput" placeholder="Введите сообщение...">
    </div>

    <div id="profileContainer" class="inactive-container">
        <!-- Профиль пользователя -->
        <div id="profileInfo"></div>
        <button id="backBtn">Назад</button>
    </div>

    <!-- Модальные окна -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <input type="text" id="newUsername" placeholder="Имя пользователя">
            <input type="password" id="newPassword" placeholder="Пароль">
            <button onclick="createUser()">Создать</button>
            <button onclick="closeModal('createUserModal')">Закрыть</button>
        </div>
    </div>

    <div id="editTimersModal" class="modal">
        <div class="modal-content">
            <div id="timersEditContainer"></div>
            <button onclick="saveTimersChanges()">Сохранить изменения</button>
            <button onclick="closeModal('editTimersModal')">Закрыть</button>
        </div>
    </div>

    <script>
        let currentUser = null;
        const users = {};
        const chatMessages = [];
        const mines = {
            'Мина 1': { max: 300, current: 300 },
            'Мина 2': { max: 200, current: 200 },
            // Добавьте другие мины здесь
        };

        // Функция для хеширования пароля с использованием SHA-256
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(byte => byte.toString(16).padStart(2, '0')).join('');
        }

        // Сохранение данных (например, в локальное хранилище)
        function saveData() {
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('chatMessages', JSON.stringify(chatMessages));
            localStorage.setItem('mines', JSON.stringify(mines));
        }

        // Загрузка данных
        function loadData() {
            const savedUsers = JSON.parse(localStorage.getItem('users'));
            const savedMessages = JSON.parse(localStorage.getItem('chatMessages'));
            const savedMines = JSON.parse(localStorage.getItem('mines'));

            if (savedUsers) {
                Object.assign(users, savedUsers);
            }
            if (savedMessages) {
                chatMessages.length = 0;
                chatMessages.push(...savedMessages);
            }
            if (savedMines) {
                Object.assign(mines, savedMines);
            }

            updateChat();
            updateTimers();
            updateProfileInfo();
        }

        // Загрузка пользователей при старте
        async function loadInitialUsers() {
            if (!Object.keys(users).length) {
                users['admin'] = {
                    password: await hashPassword('admin123'),
                    isAdmin: true
                };
                users['user1'] = {
                    password: await hashPassword('password1'),
                    isAdmin: false
                };
                saveData();
            }
        }

        // Обновление таймеров
        function updateTimers() {
            const container = document.getElementById('timersContainer');
            container.innerHTML = '';

            for (const [name, data] of Object.entries(mines)) {
                const timerDiv = document.createElement('div');
                timerDiv.className = 'timer';

                // Подсветка если время заканчивается
                if (data.current <= 20 && data.current > 0) {
                    timerDiv.classList.add('alert');
                } else if (data.current <= 60) {
                    timerDiv.classList.add('warning');
                }

                const nameSpan = document.createElement('span');
                nameSpan.className = 'timer-name';
                nameSpan.textContent = name;

                const timeSpan = document.createElement('span');
                timeSpan.className = 'timer-time';
                timeSpan.textContent = formatTime(data.current) + ' / ' + formatTime(data.max);

                timerDiv.appendChild(nameSpan);
                timerDiv.appendChild(timeSpan);

                container.appendChild(timerDiv);
            }
        }

        // Форматирование времени (минуты:секунды)
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Отправка сообщения в чат
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (message && currentUser) {
                const newMessage = {
                    sender: currentUser.username,
                    text: message,
                    timestamp: new Date().getTime()
                };

                chatMessages.push(newMessage);
                saveData();
                updateChat();
                input.value = '';

                // Прокрутка вниз
                const chatContainer = document.getElementById('chatMessages');
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // Обновление чата
        function updateChat() {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';

            chatMessages.forEach(msg => {
                const isOwn = currentUser && msg.sender === currentUser.username;
                const messageDiv = document.createElement('div');
                messageDiv.className = isOwn ? 'own-message' : 'other-message';

                const senderSpan = document.createElement('span');
                senderSpan.className = 'message-sender';
                senderSpan.textContent = msg.sender;

                const timeSpan = document.createElement('span');
                timeSpan.className = 'message-time';
                timeSpan.textContent = formatChatTime(msg.timestamp);

                const textDiv = document.createElement('div');
                textDiv.textContent = msg.text;

                messageDiv.appendChild(senderSpan);
                messageDiv.appendChild(timeSpan);
                messageDiv.appendChild(textDiv);

                container.appendChild(messageDiv);
            });

            // Прокрутка вниз
            container.scrollTop = container.scrollHeight;
        }

        // Форматирование времени для чата
        function formatChatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Обновление информации в профиле
        function updateProfileInfo() {
            const container = document.getElementById('profileInfo');
            container.innerHTML = `
                <p><strong>Имя:</strong> ${currentUser.username}</p>
                <p><strong>Роль:</strong> ${currentUser.isAdmin ? 'Администратор' : 'Пользователь'}</p>
                <p><strong>Статус:</strong> Активен</p>
            `;
        }

        // Показать экран профиля
        function showProfile() {
            document.getElementById('mainContainer').classList.remove('active-container');
            document.getElementById('profileContainer').classList.add('active-container');
        }

        // Вернуться из профиля
        function backToMain() {
            document.getElementById('profileContainer').classList.remove('active-container');
            document.getElementById('mainContainer').classList.add('active-container');
        }

        // Показать модальное окно создания пользователя
        function showCreateUserModal() {
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('createUserModal').style.display = 'flex';
        }

        // Создать нового пользователя
        async function createUser() {
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;

            if (!username || !password) {
                alert('Логин и пароль не могут быть пустыми!');
                return;
            }

            if (users[username]) {
                alert('Пользователь с таким логином уже существует!');
                return;
            }

            const hashedPassword = await hashPassword(password);

            users[username] = {
                password: hashedPassword,
                isAdmin: false
            };

            saveData();
            closeModal('createUserModal');
        }

        // Закрыть модальное окно
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Запуск
        loadData();
        loadInitialUsers();
    </script>
</body>
</html>
