<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Таймеры и Чат</title>
    <style>
        /* Тут твои стили */
        .timer { margin: 5px 0; }
        .alert { color: red; }
        .warning { color: orange; }
        .active-container { display: block; }
        #profileContainer { display: none; }
    </style>
</head>
<body>
    <div id="mainContainer" class="active-container">
        <div id="timersContainer"></div>
        <input id="chatInput" placeholder="Введите сообщение..." />
        <div id="chatMessages"></div>
        <button id="profileBtn">Профиль</button>
    </div>

    <div id="profileContainer">
        <div id="profileInfo"></div>
        <button id="backBtn">Назад</button>
    </div>

    <!-- Модальные окна -->
    <div id="createUserModal" style="display:none;">
        <input id="newUsername" placeholder="Новый логин" />
        <input id="newPassword" type="password" placeholder="Новый пароль" />
        <button onclick="createUser()">Создать</button>
        <button onclick="closeModal('createUserModal')">Отмена</button>
    </div>

    <div id="editTimersModal" style="display:none;">
        <div id="timersEditContainer"></div>
        <button onclick="saveTimersChanges()">Сохранить</button>
        <button onclick="closeModal('editTimersModal')">Отмена</button>
    </div>

    <script>
        let mines = {};
        let chatMessages = [];
        let users = {};
        let currentUser = null;

        // Функция SHA-256
        async function sha256(message) {
            const encoder = new TextEncoder();
            const data = encoder.encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Загрузка пользователей
        async function loadInitialUsers() {
            if (!localStorage.getItem('users')) {
                users = {
                    admin: {
                        password: await sha256('admin'), // Стандартный пароль "admin"
                        isAdmin: true
                    }
                };
                saveUsers();
            } else {
                users = JSON.parse(localStorage.getItem('users'));
            }
        }

        // Сохранение пользователей
        function saveUsers() {
            localStorage.setItem('users', JSON.stringify(users));
        }

        // Сохранение данных
        function saveData() {
            localStorage.setItem('mines', JSON.stringify(mines));
            localStorage.setItem('chatMessages', JSON.stringify(chatMessages));
        }

        // Загрузка данных
        function loadData() {
            if (localStorage.getItem('mines')) {
                mines = JSON.parse(localStorage.getItem('mines'));
            } else {
                // Пример начальных данных
                mines = {
                    "Шахта 1": { max: 300, current: 300 },
                    "Шахта 2": { max: 600, current: 600 }
                };
            }

            if (localStorage.getItem('chatMessages')) {
                chatMessages = JSON.parse(localStorage.getItem('chatMessages'));
            }

            updateTimers();
            updateChat();
        }

        // Обновление таймеров
        function updateTimers() {
            const container = document.getElementById('timersContainer');
            container.innerHTML = '';

            for (const [name, data] of Object.entries(mines)) {
                const timerDiv = document.createElement('div');
                timerDiv.className = 'timer';

                if (data.current <= 20 && data.current > 0) {
                    timerDiv.classList.add('alert');
                } else if (data.current <= 60) {
                    timerDiv.classList.add('warning');
                }

                const nameSpan = document.createElement('span');
                nameSpan.className = 'timer-name';
                nameSpan.textContent = name;

                const timeSpan = document.createElement('span');
                timeSpan.className = 'timer-time';
                timeSpan.textContent = `${formatTime(data.current)} / ${formatTime(data.max)}`;

                timerDiv.appendChild(nameSpan);
                timerDiv.appendChild(timeSpan);

                container.appendChild(timerDiv);
            }
        }

        // Форматирование времени (минуты:секунды)
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Отправка сообщения в чат
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (message && currentUser) {
                const newMessage = {
                    sender: currentUser.username,
                    text: message,
                    timestamp: new Date().getTime()
                };

                chatMessages.push(newMessage);
                saveData();
                updateChat();
                input.value = '';

                const chatContainer = document.getElementById('chatMessages');
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // Обновление чата
        function updateChat() {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';

            chatMessages.forEach(msg => {
                const isOwn = currentUser && msg.sender === currentUser.username;
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isOwn ? 'own-message' : 'other-message'}`;

                const senderSpan = document.createElement('span');
                senderSpan.className = 'message-sender';
                senderSpan.textContent = msg.sender;

                const timeSpan = document.createElement('span');
                timeSpan.className = 'message-time';
                timeSpan.textContent = formatChatTime(msg.timestamp);

                const textDiv = document.createElement('div');
                textDiv.textContent = msg.text;

                messageDiv.appendChild(senderSpan);
                messageDiv.appendChild(timeSpan);
                messageDiv.appendChild(textDiv);

                container.appendChild(messageDiv);
            });

            container.scrollTop = container.scrollHeight;
        }

        // Форматирование времени для чата
        function formatChatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Обновление профиля
        function updateProfileInfo() {
            const container = document.getElementById('profileInfo');
            container.innerHTML = `
                <p><strong>Имя:</strong> ${currentUser.username}</p>
                <p><strong>Роль:</strong> ${currentUser.isAdmin ? 'Администратор' : 'Пользователь'}</p>
                <p><strong>Статус:</strong> Активен</p>
            `;
        }

        function showProfile() {
            document.getElementById('mainContainer').classList.remove('active-container');
            document.getElementById('profileContainer').classList.add('active-container');
        }

        function backToMain() {
            document.getElementById('profileContainer').classList.remove('active-container');
            document.getElementById('mainContainer').classList.add('active-container');
        }

        function showCreateUserModal() {
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('createUserModal').style.display = 'flex';
        }

        async function createUser() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;

            if (!username || !password) {
                alert('Логин и пароль не могут быть пустыми!');
                return;
            }

            if (users[username]) {
                alert('Пользователь с таким логином уже существует!');
                return;
            }

            const hashedPassword = await sha256(password);

            users[username] = {
                password: hashedPassword,
                isAdmin: false
            };

            saveUsers();
            closeModal('createUserModal');
            alert(`Пользователь ${username} успешно создан!`);
        }

        function showEditTimersModal() {
            const container = document.getElementById('timersEditContainer');
            container.innerHTML = '';

            for (const [name, data] of Object.entries(mines)) {
                const timerDiv = document.createElement('div');
                timerDiv.className = 'timer';

                const nameSpan = document.createElement('span');
                nameSpan.className = 'timer-name';
                nameSpan.textContent = name;

                const maxTimeInput = document.createElement('input');
                maxTimeInput.type = 'number';
                maxTimeInput.value = data.max;
                maxTimeInput.min = 1;
                maxTimeInput.dataset.name = name;
                maxTimeInput.style.width = '80px';
                maxTimeInput.style.textAlign = 'center';

                timerDiv.appendChild(nameSpan);
                timerDiv.appendChild(maxTimeInput);

                container.appendChild(timerDiv);
            }

            document.getElementById('editTimersModal').style.display = 'flex';
        }

        function saveTimersChanges() {
            const inputs = document.querySelectorAll('#timersEditContainer input');

            inputs.forEach(input => {
                const mineName = input.dataset.name;
                const newMax = parseInt(input.value);

                if (newMax > 0) {
                    mines[mineName].max = newMax;
                    mines[mineName].current = newMax;
                }
            });

            saveData();
            updateTimers();
            closeModal('editTimersModal');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        document.getElementById('profileBtn').addEventListener('click', showProfile);
        document.getElementById('backBtn').addEventListener('click', backToMain);

        setInterval(() => {
            let updated = false;

            for (const [name, data] of Object.entries(mines)) {
                if (data.current > 0) {
                    data.current--;
                    updated = true;
                }
                if (data.current <= 0) {
                    data.current = data.max;
                    updated = true;
                }
            }

            if (updated) {
                updateTimers();
                saveData();
            }
        }, 1000);

        window.onload = async function() {
            await loadInitialUsers();
            loadData();
        };
    </script>
</body>
</html>
